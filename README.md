# QQESPM PostgreSQL Extension 

The QQESPM (Quantitative and Qualitative Efficient Spatial Pattern Matching) is a spatio-textual search solution capable of efficiently addressing searches for geo-textual objects (e.g., Points of Interest (POIs)) based on keywords, distance, topological and exclusion restrictions, within a database of spatio-textual objects. Check our initial [scientific paper](https://arxiv.org/abs/2312.08992) on the research of geo-textual QQ-SPM queries.

## Installation 

Clone the repository

    git clone git@github.com:viniciuscva/qqespm_postgres_extension.git

Access the repository folder

    cd qqespm_extension/

Copy the two necessary files to the appropriate `extension` PostgreSQL's folder on your machine. For example:

    sudo cp qqespm--1.0.sql qqespm.control /usr/share/postgresql/16/extension

Now, create a local PostgreSQL database. For example:

    CREATE DATABASE qqespm_db

## Example Usage

Create a table of geo-textual objects such as POIs (for example, using OpenStreetMap data). The table should contain the columns geometry and centroid, storing the bounding polygons and centroids of each geo-textual object. Also, the current code provided in the file `qqespm--1.0.sql` expects, as default, that a `osm_id` column in the table will exist, storing unique IDs for the geo-textual objects represented by the table's rows. 
To easily get started with this step you can simply create a sample dataset with POIs data from London, gathered and edited from OpenStreetMap. (The boundaries of the objects were augmented to create more intersections). To start this demo dataset, follow the instructions/commands described in the file `qqespm_extension_initial_config.sql` within your created database.

After that, run the following command when connected to your created database:

    CREATE EXTENSION qqespm

Now the QQESPM extension is installed. The creation of this extension defines several PLPGSQL functions that are necessary to handle QQ-SPM queries in the database.
A sample QQ-SPM query is as follows:

    SELECT * FROM match_spatial_pattern(
        array[
	    	distance_constraint('school', 'pharmacy', 10, 10000, true, false) 
	    ], 
	    'pois',
	    array['school', 'pharmacy']
    );

This sample query will return instances of `school` and `pharmacy` that are located between 10 and 10000 meters close, yielding only schools that do not contain a pharmacy closer than 10 meters. The search will the performed in the indicated `'pois'` table, and the output groups of objects will be in the order `school, pharmacy`, as determined by the third function parameter. In background, the QQESPM extension will take these spatial constraints and automatically convert them into a complete and efficient SQL spatial query, employ PostGIS spatial functions and indexes.
An explanation for the useful functions in this extension is given as documentation in the file `qqespm--1.0.sql`.

## Implicit vs. Explicit Join approach

The SQL query automatically generated for the QQ-SPM query constraints can follow either an implicit or an explicit JOIN strategy.
The example bellow shows an SQL query generated by the extension using implicit join:

	WITH
	    tb_waste_basket AS
	    (SELECT * FROM pois WHERE amenity = 'waste_basket' OR building = 'waste_basket' OR 
	    landuse = 'waste_basket' OR leisure = 'waste_basket' OR shop = 'waste_basket' OR tourism = 'waste_basket' ),
	    tb_bicycle AS
	    (SELECT * FROM pois WHERE amenity = 'bicycle' OR building = 'bicycle' OR 
	    landuse = 'bicycle' OR leisure = 'bicycle' OR shop = 'bicycle' OR tourism = 'bicycle' ),
	    tb_travel_agency AS
	    (SELECT * FROM pois WHERE amenity = 'travel_agency' OR building = 'travel_agency' OR 
	    landuse = 'travel_agency' OR leisure = 'travel_agency' OR shop = 'travel_agency' OR tourism = 'travel_agency' )
	SELECT tb_waste_basket.osm_id AS tb_waste_basket_id, tb_bicycle.osm_id AS tb_bicycle_id, 
	tb_travel_agency.osm_id AS tb_travel_agency_id
	FROM tb_waste_basket, tb_bicycle, tb_travel_agency
	WHERE 
	    ST_CoveredBy(tb_waste_basket.geometry, tb_bicycle.geometry) AND 
	    ST_DistanceSphere(tb_bicycle.centroid, tb_travel_agency.centroid) BETWEEN 81.36 AND 367.12  AND 
	    NOT EXISTS (SELECT 1 FROM tb_bicycle aux WHERE 
	        ST_DWithin(tb_travel_agency.centroid::geography, aux.centroid::geography, 81.36, false)) 

The example bellow shows an SQL query generated by the extension using explicit join:

	WITH
	    tb_travel_agency AS
	    (SELECT * FROM pois WHERE amenity = 'travel_agency' OR building = 'travel_agency' OR 
	    landuse = 'travel_agency' OR leisure = 'travel_agency' OR shop = 'travel_agency' OR tourism = 'travel_agency' ),
	    tb_bicycle AS
	    (SELECT * FROM pois WHERE amenity = 'bicycle' OR building = 'bicycle' OR 
	    landuse = 'bicycle' OR leisure = 'bicycle' OR shop = 'bicycle' OR tourism = 'bicycle' ),
	    tb_waste_basket AS
	    (SELECT * FROM pois WHERE amenity = 'waste_basket' OR building = 'waste_basket' OR 
	    landuse = 'waste_basket' OR leisure = 'waste_basket' OR shop = 'waste_basket' OR tourism = 'waste_basket' )
	SELECT tb_waste_basket.osm_id AS tb_waste_basket_id, tb_bicycle.osm_id AS tb_bicycle_id, 
	tb_travel_agency.osm_id AS tb_travel_agency_id
	FROM tb_travel_agency
	INNER JOIN tb_bicycle
	ON      
	    ST_DistanceSphere(tb_bicycle.centroid, tb_travel_agency.centroid) BETWEEN 81.36 AND 367.12  AND 
	    NOT EXISTS (SELECT 1 FROM tb_bicycle aux WHERE 
	        ST_DWithin(tb_travel_agency.centroid::geography, aux.centroid::geography, 81.36, false)) 
	INNER JOIN tb_waste_basket
	ON      
	    ST_Within(tb_waste_basket.geometry, tb_bicycle.geometry)

## License

[QQESPM PostgreSQL's extension](https://github.com/viniciuscva/qqespm_postgres_extension/) Â© 2024 by [Carlos Vinicius A. M. Pontes](https://www.linkedin.com/in/vinicius-alves-mm/) is licensed under [CC BY 4.0](https://creativecommons.org/licenses/by/4.0/?ref=chooser-v1).
